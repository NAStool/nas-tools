<div class="container-xl">
  <!-- Page title -->
  <div class="page-header d-print-none">
    <div class="row align-items-center">
      <div class="col">
        <h2 class="page-title">
          自定义订阅
        </h2>
      </div>
      <div class="col-auto ms-auto d-print-none">
        <div class="btn-list">
          <a href="javascript:show_userrss_modal()" class="btn btn-primary d-none d-sm-inline-block">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></svg>
            新建订阅任务
          </a>
          <a href="javascript:show_userrss_modal()" class="btn btn-primary d-sm-none btn-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></svg>
          </a>
          <a href="javascript:show_userrss_parser_modal()" class="btn d-none d-sm-inline-block">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-cpu" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
               <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
               <rect x="5" y="5" width="14" height="14" rx="1"></rect>
               <path d="M9 9h6v6h-6z"></path>
               <path d="M3 10h2"></path>
               <path d="M3 14h2"></path>
               <path d="M10 3v2"></path>
               <path d="M14 3v2"></path>
               <path d="M21 10h-2"></path>
               <path d="M21 14h-2"></path>
               <path d="M14 21v-2"></path>
               <path d="M10 21v-2"></path>
            </svg>
            RSS解析器
          </a>
          <a href="javascript:show_userrss_parser_modal()" class="btn btn-secondary d-sm-none btn-icon" title="RSS解析器">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-cpu" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
               <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
               <rect x="5" y="5" width="14" height="14" rx="1"></rect>
               <path d="M9 9h6v6h-6z"></path>
               <path d="M3 10h2"></path>
               <path d="M3 14h2"></path>
               <path d="M10 3v2"></path>
               <path d="M14 3v2"></path>
               <path d="M21 10h-2"></path>
               <path d="M21 14h-2"></path>
               <path d="M14 21v-2"></path>
               <path d="M10 21v-2"></path>
            </svg>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% if Count > 0 %}
<div class="page-body">
  <div class="container-xl">
    <div class="row row-cards">
      {% for Task in Tasks %}
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">{{ Task.name }}</h3>
          <div class="ms-2">
            <a href="javascript:run_userrss_now('{{ Task.id }}')" class="btn-icon" title="立即运行任务" data-bs-toggle="tooltip">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-bolt icon-filled" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                 <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                 <polyline points="13 3 13 10 19 10 11 21 11 14 5 14 13 3"></polyline>
              </svg>
            </a>
          </div>
          <div class="card-actions btn-actions">
              <a href="javascript:edit_userrss_modal('{{ Task.id }}')" class="btn-action" title="编辑任务">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon ms-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 7h-3a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-3" /><path d="M9 15h3l8.5 -8.5a1.5 1.5 0 0 0 -3 -3l-8.5 8.5v3" /><line x1="16" y1="5" x2="19" y2="8" /></svg>
              </a>
              <a href="javascript:del_userrss_modal('{{ Task.id }}', '{{ Task.name }}')" class="btn-action" title="删除任务">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><desc>Download more icon variants from https://tabler-icons.io/i/x</desc><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></svg>
              </a>
            </div>
        </div>
        <div class="card-body">
          <div class="datagrid">
            <div class="datagrid-item">
              <div class="datagrid-title">地址</div>
              <div class="datagrid-content">
                <div class="d-flex align-items-center">
                  {{ Task.address|split('?', 0) }}
                </div>
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">解析器</div>
              <div class="datagrid-content">
                <span class="badge me-2">{{ Task.parser_name }}</span>
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">刷新间隔</div>
              <div class="datagrid-content">
                {{ Task.interval }} 分钟
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">动作</div>
              <div class="datagrid-content">
                <span class="badge me-2 bg-blue">{{ Task.uses_text }}</span>
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">包含</div>
              <div class="datagrid-content">
                {% if Task.include %}
                <span class="badge badge-outline text-green me-2">{{ Task.include }}</span>
                {% endif %}
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">排除</div>
              <div class="datagrid-content">
                {% if Task.exclude %}
                <span class="badge badge-outline text-red me-2">{{ Task.exclude }}</span>
                {% endif %}
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">过滤规则</div>
              <div class="datagrid-content">
                {% if Task.filter_name %}
                <span class="badge badge-outline text-orange me-2">{{ Task.filter_name }}</span>
                {% endif %}
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">保存路径</div>
              <div class="datagrid-content">{{ Task.save_dir or '自动' }}</div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">状态</div>
              <div class="datagrid-content">
                {% if Task.state == 'Y' %}
                <span class="badge me-2 bg-green">正在运行</span>
                {% else %}
                <span class="badge me-2 bg-red">已停用</span>
                {% endif %}
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">已处理数量</div>
              <div class="datagrid-content">
                {{ Task.counter or 0 }}
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">最后更新时间</div>
              <div class="datagrid-content">
                {{ Task.update_time or '' }}
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% else %}
<div class="page-body">
  <div class="container-xl d-flex flex-column justify-content-center">
    <div class="empty">
      <div class="empty-img"><img src="./static/img/quitting_time.svg" height="128"  alt="">
      </div>
      <p class="empty-title">没有记录</p>
      <p class="empty-subtitle text-muted">
        当前没有正在运行的自定义订阅任务
      </p>
    </div>
  </div>
</div>
{% endif %}
<div class="modal modal-blur fade" id="modal-userrss" tabindex="-1" role="dialog" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="card border-top-0">
        <div class="card-header">
          <h5 class="modal-title" id="userrss_modal_title">新建任务</h5>
          <input type="hidden" id="userrss_id">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-lg-4">
              <div class="mb-3">
                <label class="form-label required">名称</label>
                <input type="text" id="userrss_name" class="form-control" placeholder="别名">
              </div>
            </div>
            <div class="col-lg-4">
              <div class="mb-3">
                <label class="form-label required">动作 <span class="form-help" title="【下载】RSS中包含enclosure种子链接，直接下载种子文件；【订阅】根据RSS中的title识别并添加订阅，由订阅管理下载；【搜索】根据RSS中的title识别和搜索资源，仅搜索一次。title中的信息不足时，如有则会使用type及year的数据" data-bs-toggle="tooltip">?</span></label>
                <select class="form-select" id="userrss_uses">
                  <option value="D" selected>下载</option>
                  <option value="R">订阅</option>
                  <option value="S">搜索</option>
                </select>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="mb-3">
                <label class="form-label required">刷新间隔(分钟) <span class="form-help" title="检查RSS更新的间隔时间" data-bs-toggle="tooltip">?</span></label>
                <input type="text" id="userrss_interval" class="form-control" placeholder="30">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-8">
              <div class="mb-3">
                <label class="form-label required">地址  <span class="form-help" title="RSS订阅的链接地址" data-bs-toggle="tooltip">?</span></label>
                <input type="text" id="userrss_address" class="form-control" placeholder="RSS地址">
              </div>
            </div>
            <div class="col-lg-4">
              <div class="mb-3">
                <label class="form-label required">解析器 <span class="form-help" title="使用RSS解析器中配置的解析格式解析RSS报文" data-bs-toggle="tooltip">?</span></label>
                <select class="form-select" id="userrss_parser">
                  {% for RssParser in RssParsers %}
                  <option value="{{ RssParser.id }}" {% if loop.first %}selected{% endif %}>{{ RssParser.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-4">
              <div class="mb-3">
                <label class="form-label">包含 <span class="form-help" title="RSS报文中title符合包括规则的才会被处理" data-bs-toggle="tooltip">?</span></label>
                <input type="text" id="userrss_include" class="form-control" placeholder="关键字/正则表达式">
              </div>
            </div>
            <div class="col-lg-4">
              <div class="mb-3">
                <label class="form-label">排除 <span class="form-help" title="RSS报文中title符合排除规则的则不会被处理" data-bs-toggle="tooltip">?</span></label>
                <input type="text" id="userrss_exclude" class="form-control" placeholder="关键字/正则表达式">
              </div>
            </div>
            <div class="col-lg-4">
              <div class="mb-3">
                <label class="form-label">过滤规则 <span class="form-help" title="只有符合过滤规则的才会被处理" data-bs-toggle="tooltip">?</span></label>
                <select class="form-select" id="userrss_filterrule">
                  <option value="" selected>请选择</option>
                  {% for FilterRule in FilterRules %}
                  <option value="{{ FilterRule.id }}">{{ FilterRule.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-8">
              <div class="mb-3">
                <label class="form-label">保存路径</label>
                <input type="text" id="userrss_note" class="form-control" placeholder="留空自动选择保存路径">
              </div>
            </div>
            <div class="col-lg-4">
              <div class="mb-3">
                <label class="form-label required">状态</label>
                <select class="form-select" id="userrss_state">
                  <option value="Y" selected>正常</option>
                  <option value="N">停用</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-link me-auto" data-bs-dismiss="modal">取消</button>
        <a href="javascript:add_or_edit_userrss_task()" id="add_or_edit_userrss_btn" class="btn btn-primary">确定</a>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
  // 显示新增任务
  function show_userrss_modal(){
    $("#userrss_id").val('');
    $("#add_or_edit_userrss_btn").text('新增');
    $("#modal-userrss").modal('show');
  }

  // 显示编辑刷流任务
  function edit_userrss_modal(id){
    $("#userrss_id").val(id);
    ajax_post("get_userrss_task", {id:id}, function (ret) {
      if(ret.code == 0){
        $("#userrss_name").val(ret.detail.name);
        $("#userrss_interval").val(ret.detail.interval);
        $("#userrss_address").val(ret.detail.address);
        $("#userrss_include").val(ret.detail.include);
        $("#userrss_exclude").val(ret.detail.exclude);
        $("#userrss_filterrule").val(ret.detail.filter);
        $("#userrss_parser").val(ret.detail.parser);
        $("#userrss_state").val(ret.detail.state);
        $("#userrss_uses").val(ret.detail.uses);
        $("#userrss_note").val(ret.detail.save_dir);
        $("#modal-userrss").modal('show');
      }
    });
  }

  // 显示删除刷流任务
  function del_userrss_modal(taskid, name){
    show_confirm_modal("删除订阅任务 " + name + " ？" , function(){
      hide_confirm_modal();
      ajax_post("delete_userrss_task", {"id": taskid}, function(ret){
        navmenu('user_rss');
      });
    });
  }

  // 新增任务保存
  function add_or_edit_userrss_task(){
    id = $("#userrss_id").val();
    name = $("#userrss_name").val();
    if(!name){
      $("#userrss_name").addClass("is-invalid");
      return;
    }else{
      $("#userrss_name").removeClass("is-invalid");
    }
    interval = $("#userrss_interval").val();
    if(!interval || isNaN(interval)){
      $("#userrss_interval").addClass("is-invalid");
      return;
    }else{
      $("#userrss_interval").removeClass("is-invalid");
    }
    address = $("#userrss_address").val();
    if(!address){
      $("#userrss_address").addClass("is-invalid");
      return;
    }else{
      $("#userrss_address").removeClass("is-invalid");
    }
    parser = $("#userrss_parser").val();
    if(!parser){
      $("#userrss_parser").addClass("is-invalid");
      return;
    }else{
      $("#userrss_parser").removeClass("is-invalid");
    }
    var params = {id: id,
                  name: name,
                  address: address,
                  parser: parser,
                  interval: interval,
                  uses: $("#userrss_uses").val(),
                  include: $("#userrss_include").val(),
                  exclude: $("#userrss_exclude").val(),
                  filterrule: $("#userrss_filterrule").val(),
                  state: $("#userrss_state").val(),
                  note: $("#userrss_note").val()};
    ajax_post("update_userrss_task", params, function(ret){
      $("#modal-userrss").modal('hide');
      navmenu('user_rss');
    });
  }

  // RSS解析器
  function show_userrss_parser_modal(){
    navmenu('rss_parser');
  }

  //立即运行任务
  function run_userrss_now(id){
    show_wait_process();
    ajax_post("run_userrss", {"id": id}, function(ret){
      hide_wait_process();
      show_success_modal("任务运行完成！", function(){
        navmenu('user_rss');
      });
    });
  }

</script>