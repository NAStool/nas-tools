<div class="container-xl">
  <!-- Page title -->
  <div class="page-header d-print-none">
    <div class="row align-items-center">
      <div class="col">
        <h2 class="page-title">
          自定义订阅
        </h2>
      </div>
      <div class="col-auto ms-auto d-print-none">
        <div class="btn-list">
          <a href="javascript:show_userrss_modal()" class="btn btn-primary d-none d-sm-inline-block">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></svg>
            新建订阅任务
          </a>
          <a href="javascript:show_userrss_modal()" class="btn btn-primary d-sm-none btn-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></svg>
          </a>
          <a href="javascript:show_userrss_parser_modal()" class="btn d-none d-sm-inline-block">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-cpu" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
               <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
               <rect x="5" y="5" width="14" height="14" rx="1"></rect>
               <path d="M9 9h6v6h-6z"></path>
               <path d="M3 10h2"></path>
               <path d="M3 14h2"></path>
               <path d="M10 3v2"></path>
               <path d="M14 3v2"></path>
               <path d="M21 10h-2"></path>
               <path d="M21 14h-2"></path>
               <path d="M14 21v-2"></path>
               <path d="M10 21v-2"></path>
            </svg>
            RSS解析器
          </a>
          <a href="javascript:show_userrss_parser_modal()" class="btn btn-secondary d-sm-none btn-icon" title="RSS解析器">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-cpu" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
               <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
               <rect x="5" y="5" width="14" height="14" rx="1"></rect>
               <path d="M9 9h6v6h-6z"></path>
               <path d="M3 10h2"></path>
               <path d="M3 14h2"></path>
               <path d="M10 3v2"></path>
               <path d="M14 3v2"></path>
               <path d="M21 10h-2"></path>
               <path d="M21 14h-2"></path>
               <path d="M14 21v-2"></path>
               <path d="M10 21v-2"></path>
            </svg>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% if Count > 0 %}
<div class="page-body">
  <div class="container-xl">
    <div class="row row-cards">
      {% for Task in Tasks %}
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">{{ Task.name }}</h3>
          <div class="ms-2">
            <a href="javascript:run_userrss_now('{{ Task.id }}')" class="btn-icon" title="立即运行任务" data-bs-toggle="tooltip">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-bolt icon-filled" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                 <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                 <polyline points="13 3 13 10 19 10 11 21 11 14 5 14 13 3"></polyline>
              </svg>
            </a>
          </div>
          <div class="card-actions btn-actions">
            <a href="javascript:show_userrss_detail('{{ Task.id }}')" class="btn-action">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon ms-1" width="20" height="20" fill="currentColor"  viewBox="0 0 16 16"> <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/> </svg>
            </a>
            <a href="javascript:edit_userrss_modal('{{ Task.id }}')" class="btn-action" title="编辑任务">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon ms-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 7h-3a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-3" /><path d="M9 15h3l8.5 -8.5a1.5 1.5 0 0 0 -3 -3l-8.5 8.5v3" /><line x1="16" y1="5" x2="19" y2="8" /></svg>
            </a>
            <a href="javascript:del_userrss_modal('{{ Task.id }}', '{{ Task.name }}')" class="btn-action" title="删除任务">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><desc>Download more icon variants from https://tabler-icons.io/i/x</desc><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></svg>
            </a>
          </div>
        </div>
        <div class="card-body" id="detail_{{ Task.id }}" style="display: {% if Count > 2 %}none{% else %}block{% endif %};">
          <div class="datagrid">
            <div class="datagrid-item">
              <div class="datagrid-title">地址</div>
              <div class="datagrid-content">
                <div class="d-flex align-items-center">
                  {{ Task.address|split('?', 0) }}
                </div>
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">解析器</div>
              <div class="datagrid-content">
                <span class="badge me-2">{{ Task.parser_name }}</span>
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">刷新间隔</div>
              <div class="datagrid-content">
                {{ Task.interval }} 分钟
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">动作</div>
              <div class="datagrid-content">
                <span class="badge me-2 bg-blue">{{ Task.uses_text }}</span>
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">包含</div>
              <div class="datagrid-content">
                {% if Task.include %}
                <span class="badge badge-outline text-green me-2">{{ Task.include }}</span>
                {% endif %}
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">排除</div>
              <div class="datagrid-content">
                {% if Task.exclude %}
                <span class="badge badge-outline text-red me-2">{{ Task.exclude }}</span>
                {% endif %}
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">过滤规则</div>
              <div class="datagrid-content">
                {% if Task.filter_name %}
                <span class="badge badge-outline text-orange me-2">{{ Task.filter_name }}</span>
                {% endif %}
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">保存路径</div>
              <div class="datagrid-content">{{ Task.note.save_path or '自动' }}</div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">状态</div>
              <div class="datagrid-content">
                {% if Task.state == 'Y' %}
                <span class="badge me-2 bg-green">正在运行</span>
                {% else %}
                <span class="badge me-2 bg-red">已停用</span>
                {% endif %}
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">已处理数量</div>
              <div class="datagrid-content">
                {% if Task.uses == 'D' %}
                <a id="rss_history_btn" href="javascript:show_rss_history_modal('{{ Task.id }}')" class="btn-link">
                  {{ Task.counter or 0 }}
                </a>
                {% else %}
                  {{ Task.counter or 0 }}
                {% endif %}
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">最后更新时间</div>
              <div class="datagrid-content">
                {{ Task.update_time or '' }}
              </div>
            </div>
            {% if Task.uses == 'D' %}
            <div class="datagrid-item">
              <div class="datagrid-content">
                <a id="rss_articlesbtn" href="javascript:show_rss_articles_modal('{{ Task.id }}')" class="btn btn-secondary">
                  预览
                </a>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% else %}
<div class="page-body">
  <div class="container-xl d-flex flex-column justify-content-center">
    <div class="empty">
      <div class="empty-img"><img src="./static/img/quitting_time.svg" height="128"  alt="">
      </div>
      <p class="empty-title">没有记录</p>
      <p class="empty-subtitle text-muted">
        当前没有正在运行的自定义订阅任务
      </p>
    </div>
  </div>
</div>
{% endif %}
<div class="modal modal-blur fade" id="modal-userrss" tabindex="-1" role="dialog" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="card border-top-0">
        <div class="card-header">
          <h5 class="modal-title" id="userrss_modal_title"></h5>
          <input type="hidden" id="userrss_id">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-lg-4">
              <div class="mb-3">
                <label class="form-label required">名称</label>
                <input type="text" id="userrss_name" class="form-control" placeholder="别名">
              </div>
            </div>
            <div class="col-lg-4">
              <div class="mb-3">
                <label class="form-label required">动作 <span class="form-help" title="【下载】RSS中包含enclosure种子链接，直接下载种子文件；【订阅】根据RSS中的title识别并添加订阅，由订阅管理下载；【搜索】根据RSS中的title识别和搜索资源，仅搜索一次。title中的信息不足时，如有则会使用type及year的数据" data-bs-toggle="tooltip">?</span></label>
                <select class="form-select" id="userrss_uses">
                  <option value="D" selected>下载</option>
                  <option value="R">订阅</option>
                  <option value="S">搜索</option>
                </select>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="mb-3">
                <label class="form-label required">刷新间隔(分钟) <span class="form-help" title="检查RSS更新的间隔时间" data-bs-toggle="tooltip">?</span></label>
                <input type="text" id="userrss_interval" class="form-control" placeholder="30">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-8">
              <div class="mb-3">
                <label class="form-label required">地址  <span class="form-help" title="RSS订阅的链接地址" data-bs-toggle="tooltip">?</span></label>
                <input type="text" id="userrss_address" class="form-control" placeholder="RSS地址">
              </div>
            </div>
            <div class="col-lg-4">
              <div class="mb-3">
                <label class="form-label required">解析器 <span class="form-help" title="使用RSS解析器中配置的解析格式解析RSS报文" data-bs-toggle="tooltip">?</span></label>
                <select class="form-select" id="userrss_parser">
                  {% for RssParser in RssParsers %}
                  <option value="{{ RssParser.id }}" {% if loop.first %}selected{% endif %}>{{ RssParser.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-4">
              <div class="mb-3">
                <label class="form-label">包含 <span class="form-help" title="RSS报文中title符合包括规则的才会被处理" data-bs-toggle="tooltip">?</span></label>
                <input type="text" id="userrss_include" class="form-control" placeholder="关键字/正则表达式">
              </div>
            </div>
            <div class="col-lg-4">
              <div class="mb-3">
                <label class="form-label">排除 <span class="form-help" title="RSS报文中title符合排除规则的则不会被处理" data-bs-toggle="tooltip">?</span></label>
                <input type="text" id="userrss_exclude" class="form-control" placeholder="关键字/正则表达式">
              </div>
            </div>
            <div class="col-lg-4">
              <div class="mb-3">
                <label class="form-label">过滤规则 <span class="form-help" title="只有符合过滤规则的才会被处理" data-bs-toggle="tooltip">?</span></label>
                <select class="form-select" id="userrss_filterrule">
                  <option value="" selected>请选择</option>
                  {% for FilterRule in FilterRules %}
                  <option value="{{ FilterRule.id }}">{{ FilterRule.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-8">
              <div class="mb-3">
                <label class="form-label">保存路径</label>
                <input type="text" id="userrss_note_path" class="form-control" placeholder="留空自动选择保存路径">
              </div>
            </div>
            <div class="col-lg-4">
              <div class="mb-3">
                <label class="form-label required">状态</label>
                <select class="form-select" id="userrss_state">
                  <option value="Y" selected>正常</option>
                  <option value="N">停用</option>
                </select>
              </div>
            </div>
          </div>
          <details>
            <summary class="summary mb-2">
              下载设置 <span class="form-help" title="下载设置仅适用于Qbittorrent和Transmission，其中分类和布局仅适用于Qbittorrent" data-bs-toggle="tooltip">?</span>
            </summary>
            <div class="row">
              <div class="col-lg-3">
                <div class="mb-3">
                  <label class="form-label">分类 </label>
                  <input type="text" id="userrss_note_category" class="form-control" placeholder="只能设置一个">
                </div>
              </div>
              <div class="col-lg-3">
                <div class="mb-3">
                  <label class="form-label">标签 </label>
                  <input type="text" id="userrss_note_tags" class="form-control" placeholder="多个标签用|分隔">
                </div>
              </div>
              <div class="col-lg-3">
                <div class="mb-3">
                  <label class="form-label">布局 </label>
                  <select class="form-select" id="userrss_note_layout">
                    <option value="" selected>全局</option>
                    <option value="Original">原始</option>
                    <option value="Subfolder">创建子文件夹</option>
                    <option value="NoSubfolder">不建子文件夹</option>
                  </select>
                </div>
              </div>
              <div class="col-lg-3">
                <div class="mb-3">
                  <label class="form-label">动作 </label>
                  <select class="form-select" id="userrss_note_paused">
                    <option value="" selected>添加后开始</option>
                    <option value="Y">添加后暂停</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-lg-3">
                <div class="mb-3">
                  <label class="form-label">上传速度限制 </label>
                  <input type="text" id="userrss_note_upload" class="form-control" placeholder="KB/s，不启用则留空">
                </div>
              </div>
              <div class="col-lg-3">
                <div class="mb-3">
                  <label class="form-label">下载速度限制 </label>
                  <input type="text" id="userrss_note_download" class="form-control" placeholder="KB/s，不启用则留空">
                </div>
              </div>
              <div class="col-lg-3">
                <div class="mb-3">
                  <label class="form-label">分享率限制 </label>
                  <input type="text" id="userrss_note_ratio" class="form-control" placeholder="不启用则留空">
                </div>
              </div>
              <div class="col-lg-3">
                <div class="mb-3">
                  <label class="form-label">做种时间限制 </label>
                  <input type="text" id="userrss_note_seeding_time" class="form-control" placeholder="分钟，不启用则留空">
                </div>
              </div>
            </div>
            <div class="row">
            </div>
          </details>
          {% if Count > 0 %}
          <details>
            <summary class="summary">
              模板
            </summary>
            <div class="row mt-2">
              <div class="form-selectgroup">
                {% for Task in Tasks %}
                <label class="form-selectgroup-item">
                  <input type="button" class="form-selectgroup-input" onclick="javascript:apply_templated('{{ loop.index0 }}')">
                  <span class="form-selectgroup-label">{{ Task.name }}</span>
                </label>
                {% endfor %}
              </div>
            </div>
          </details>
          {% endif %}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-link me-auto" data-bs-dismiss="modal">取消</button>
        <a href="javascript:add_or_edit_userrss_task()" id="add_or_edit_userrss_btn" class="btn btn-primary">保存</a>
      </div>
    </div>
  </div>
</div>
<div class="modal modal-blur fade" id="modal-rss-articles" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="card border-top-0">
        <div class="card-header">
          <div class="ms-2">
            <h5 class="modal-title">订阅预览</h5>
          </div>
          <div class="ms-auto" id="articles-check"></div>
          <div class="ms-5">
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
        </div>
        <div class="table-responsive" style="overflow-y: auto; max-height: 35em;">
          <table id="table-rss-articles" class="table table-vcenter card-table">
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal modal-blur fade" id="modal-rss-history" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="card border-top-0">
        <div class="card-header">
          <h5 class="modal-title">订阅下载历史</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="table-responsive" style="overflow-y: auto; max-height: 35em;">
          <table id="table-rss-history" class="table table-vcenter card-table">
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
  // 显示新增任务
  function show_userrss_modal(){
    $("#userrss_id").val('');
    $("#userrss_modal_title").text("新增订阅");
    $("#userrss_name").val('');
    $("#userrss_interval").val('');
    $("#userrss_address").val('');
    $("#userrss_include").val('');
    $("#userrss_exclude").val('');
    $("#userrss_filterrule").val('');
    $("#userrss_parser").val('1');
    $("#userrss_state").val('N');
    $("#userrss_uses").val('D');
    $("#userrss_note_path").val('');
    $("#userrss_note_category").val('');
    $("#userrss_note_tags").val('');
    $("#userrss_note_layout").val('');
    $("#userrss_note_paused").val('');
    $("#userrss_note_upload").val('');
    $("#userrss_note_download").val('');
    $("#userrss_note_ratio").val('');
    $("#userrss_note_seeding_time").val('');
    $("#modal-userrss").modal('show');
  }

  // 显示编辑刷流任务
  function edit_userrss_modal(id){
    $("#userrss_id").val(id);
    ajax_post("get_userrss_task", {id:id}, function (ret) {
      if(ret.code == 0){
        $("#userrss_modal_title").text("编辑订阅");
        $("#userrss_name").val(ret.detail.name);
        $("#userrss_interval").val(ret.detail.interval);
        $("#userrss_address").val(ret.detail.address);
        $("#userrss_include").val(ret.detail.include);
        $("#userrss_exclude").val(ret.detail.exclude);
        $("#userrss_filterrule").val(ret.detail.filter);
        $("#userrss_parser").val(ret.detail.parser);
        $("#userrss_state").val(ret.detail.state);
        $("#userrss_uses").val(ret.detail.uses);
        $("#userrss_note_path").val(ret.detail.note.save_path);
        $("#userrss_note_category").val(ret.detail.note.category);
        $("#userrss_note_tags").val(ret.detail.note.tags);
        $("#userrss_note_layout").val(ret.detail.note.content_layout);
        $("#userrss_note_paused").val(ret.detail.note.is_paused);
        $("#userrss_note_upload").val(ret.detail.note.upload_limit);
        $("#userrss_note_download").val(ret.detail.note.download_limit);
        $("#userrss_note_ratio").val(ret.detail.note.ratio_limit);
        $("#userrss_note_seeding_time").val(ret.detail.note.seeding_time_limit);
        $("#modal-userrss").modal('show');
      }
    });
  }

  // 显示删除刷流任务
  function del_userrss_modal(taskid, name){
    show_confirm_modal("删除订阅任务 " + name + " ？" , function(){
      hide_confirm_modal();
      ajax_post("delete_userrss_task", {"id": taskid}, function(ret){
        navmenu('user_rss');
      });
    });
  }

  // 折叠任务详情
  function show_userrss_detail(taskid){
    if($(`#detail_${taskid}`)[0].style["display"] == "none"){
      $(`#detail_${taskid}`).attr("style", "display: block;");
    }else{
      $(`#detail_${taskid}`).attr("style", "display: none;");
    };
  }

  // 新增/编辑任务保存
  function add_or_edit_userrss_task(){
    $("#add_or_edit_userrss_btn").text("保存中").attr("disabled", true);
    id = $("#userrss_id").val();
    name = $("#userrss_name").val();
    if(!name){
      $("#userrss_name").addClass("is-invalid");
      return;
    }else{
      $("#userrss_name").removeClass("is-invalid");
    }
    interval = $("#userrss_interval").val();
    if(!interval || isNaN(interval)){
      $("#userrss_interval").addClass("is-invalid");
      return;
    }else{
      $("#userrss_interval").removeClass("is-invalid");
    }
    address = $("#userrss_address").val();
    if(!address){
      $("#userrss_address").addClass("is-invalid");
      return;
    }else{
      $("#userrss_address").removeClass("is-invalid");
    }
    parser = $("#userrss_parser").val();
    if(!parser){
      $("#userrss_parser").addClass("is-invalid");
      return;
    }else{
      $("#userrss_parser").removeClass("is-invalid");
    }
    save_path = $("#userrss_note_path").val();
    category = $("#userrss_note_category").val();
    tags = $("#userrss_note_tags").val();
    content_layout = $("#userrss_note_layout").val();
    is_paused = $("#userrss_note_paused").val();
    upload_limit = $("#userrss_note_upload").val();
    if(upload_limit && isNaN(upload_limit)){
      $("#userrss_note_upload").addClass("is-invalid");
      return;
    }else{
      $("#userrss_note_upload").removeClass("is-invalid");
    }
    download_limit = $("#userrss_note_download").val();
    if(download_limit && isNaN(download_limit)){
      $("#userrss_note_download").addClass("is-invalid");
      return;
    }else{
      $("#userrss_note_download").removeClass("is-invalid");
    }
    ratio_limit = $("#userrss_note_ratio").val();
    if(ratio_limit && isNaN(ratio_limit)){
      $("#userrss_note_ratio").addClass("is-invalid");
      return;
    }else{
      $("#userrss_note_ratio").removeClass("is-invalid");
    }
    seeding_time_limit = $("#userrss_note_seeding_time").val();
    if(seeding_time_limit && isNaN(seeding_time_limit)){
      $("#userrss_note_seeding_time").addClass("is-invalid");
      return;
    }else{
      $("#userrss_note_seeding_time").removeClass("is-invalid");
    }
    note = {save_path: save_path,
            category: category,
            tags: tags,
            content_layout: content_layout,
            is_paused: is_paused,
            upload_limit: upload_limit,
            download_limit: download_limit,
            ratio_limit: ratio_limit,
            seeding_time_limit: seeding_time_limit};
    var params = {id: id,
                  name: name,
                  address: address,
                  parser: parser,
                  interval: interval,
                  uses: $("#userrss_uses").val(),
                  include: $("#userrss_include").val(),
                  exclude: $("#userrss_exclude").val(),
                  filterrule: $("#userrss_filterrule").val(),
                  state: $("#userrss_state").val(),
                  note: JSON.stringify(note)};
    ajax_post("update_userrss_task", params, function(ret){
      $("#modal-userrss").modal('hide');
      $("#add_or_edit_userrss_btn").attr("disabled", false);
      navmenu('user_rss');
    });
  }

  // RSS解析器
  function show_userrss_parser_modal(){
    navmenu('rss_parser');
  }

  // 立即运行任务
  function run_userrss_now(id){
    show_wait_process();
    ajax_post("run_userrss", {"id": id}, function(ret){
      hide_wait_process();
      show_success_modal("任务运行完成！", function(){
        navmenu('user_rss');
      });
    });
  }
  
  // 报文预览
  function show_rss_articles_modal(id){
    show_wait_process();
    ajax_post("list_rss_articles", {"id": id}, function(ret){
      hide_wait_process();
      $("#table-rss-articles").empty();
      $("#articles-check").empty();
      if(ret.code == 0){
        articles = ret.data;
        var content_th = `<thead><tr>
                          <th class="w-1"><input class="form-check-input m-0 align-middle" id="articles_check_all_btn" type="checkbox" aria-label="全选"></th>
                          <th>标题</th>
                          <th>状态</th>
                          <th>发布时间</th>
                          <th></th>
                          </tr></thead>`;
        var content_td = '';
        for(var i = 0; i < articles.length; i ++){
          var article = articles[i];
          var title = '';
          var link = '';
          var size = '';
          var date = '';
          var finish_flag = '';
          if(article.title){
            title_param = article.title.replace(/\'/g, "&#39;");
            input_checkbox = `<input class="form-check-input m-0 align-middle" id="check_${i}" type="checkbox">
                              <input type="hidden" id="enclosure_${i}" value="${article.enclosure}">
                              <input type="hidden" id="title_${i}" value="${title_param}">`;
            title = `<span>${article.title}</span> 
                      <a class="ms-2" title="识别匹配" href='javascript:rss_article_test("${i}", "${id}", "${title_param}")' data-bs-toggle="tooltip">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                          <path d="M4 5h7"></path>
                          <path d="M9 3v2c0 4.418 -2.239 8 -5 8"></path>
                          <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"></path>
                          <path d="M12 20l4 -9l4 9"></path>
                          <path d="M19.1 18h-6.2"></path>
                        </svg>
                      </a>`;
            if(article.link){
              title = `<a href="${article.link}" target="_blank">${title}</a>`;
            };
          };
          if(article.date){
            date = article.date.split(" ");
            date = `<small>${date[0]}<br>${date[1]}</small>`;
          };
          if(article.size){
            size = `<span class="badge badge-outline text-green me-1 mb-1" title="大小">${article.size}</span>`;
          };
          if(article.finish_flag){
            finish_flag = `<span class="badge badge-outline text-blue me-1 mb-1">已处理</span>`;
          }else{
            finish_flag = `<span class="badge badge-outline text-yellow me-1 mb-1">未处理</span>`;
          };
          download_btn = `<a href='javascript:single_article_download("${id}", "${i}")' title="下载">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-download" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                              <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2"></path>
                              <polyline points="7 11 12 16 17 11"></polyline>
                              <line x1="12" y1="4" x2="12" y2="16"></line>
                            </svg>
                          </a>`
          var content_td = `${content_td}<tr><td>${input_checkbox}</td><td>${title}${size}<div id='info_${i}'></div></td>><td id='flag_${i}'>${finish_flag}</td><td class="text-nowrap">${date}</td><td>${download_btn}</td></tr>`;
        content_tb = `<tbody>${content_td}</tbody>`;
        content = `${content_th}${content_tb}`;
        };
        batch_download_btn = `<a href="javascript:batch_articles_action('${id}', 'download')" class="btn btn-primary ms-auto d-none d-sm-inline-block">批量下载</a>`;
        batch_download_btn += `<a href="javascript:batch_articles_action('${id}', 'download')" class="btn btn-primary d-sm-none btn-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-download" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                   <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                   <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2"></path>
                                   <polyline points="7 11 12 16 17 11"></polyline>
                                   <line x1="12" y1="4" x2="12" y2="16"></line>
                                </svg>
                               </a>`;
        unfinish_btn = `<a href="javascript:batch_articles_action('${id}', 'set_finished')" class="btn btn-success ms-auto d-none d-sm-inline-block">设为已处理</a>`;
        unfinish_btn += `<a href="javascript:batch_articles_action('${id}', 'set_finished')" class="btn btn-success d-sm-none btn-icon">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-list-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                             <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                             <path d="M3.5 5.5l1.5 1.5l2.5 -2.5"></path>
                             <path d="M3.5 11.5l1.5 1.5l2.5 -2.5"></path>
                             <path d="M3.5 17.5l1.5 1.5l2.5 -2.5"></path>
                             <line x1="11" y1="6" x2="20" y2="6"></line>
                             <line x1="11" y1="12" x2="20" y2="12"></line>
                             <line x1="11" y1="18" x2="20" y2="18"></line>
                          </svg>
                         </a>`;
        finished_btn = `<a href="javascript:batch_articles_action('${id}', 'set_unfinish')" class="btn btn-secondary ms-auto d-none d-sm-inline-block">设为未处理</a>`;
        finished_btn += `<a href="javascript:batch_articles_action('${id}', 'set_unfinish')" class="btn btn-secondary d-sm-none btn-icon">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-list-details" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                             <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                             <path d="M13 5h8"></path>
                             <path d="M13 9h5"></path>
                             <path d="M13 15h8"></path>
                             <path d="M13 19h5"></path>
                             <rect x="3" y="4" width="6" height="6" rx="1"></rect>
                             <rect x="3" y="14" width="6" height="6" rx="1"></rect>
                          </svg>
                         </a>`;
        $("#articles-check").append(`<div class="btn-list">${batch_download_btn}${unfinish_btn}${finished_btn}</div>`);
        $("#table-rss-articles").append(content);
        // 绑定全选事件
        $("#articles_check_all_btn").bind("change",function(){
            $("input[type=checkbox]").prop("checked", $("#articles_check_all_btn").prop("checked"));
        });
      }else{
        var content = `<div class="empty"><p class="empty-title">${ret.msg}</p></div>`;
        $("#table-rss-articles").append(content);
      };
      $("#modal-rss-articles").modal('show');
    });
  }
  

  // 批量处理
  function batch_articles_action(id, flag){
    var articles = [];
    var i = 0;
    $("input[type=checkbox]").each(function(){
      if ($(this).prop("checked")) {
        checkid = $(this).attr("id");
        if (checkid && checkid.startsWith("check_")) {
          title = $(`#${checkid.replace("check", "title")}`).val();
          enclosure = $(`#${checkid.replace("check", "enclosure")}`).val();
          if(title || enclosure){
            articles[i] = {title: title, enclosure: enclosure}
            i = i + 1;
          }
        }
      }
    });
    if(articles.length == 0){
      return;
    }
    if(flag.startsWith("set_")){
      articles_check(id, flag, articles);
    }else if(flag == "download"){
      articles_download(id, articles);
    }else{
      return
    }
  }


  // 报文处理设置
  function articles_check(id, flag, articles){
    $("#modal-rss-articles").modal('hide');
    show_wait_process();
    ajax_post("rss_articles_check", {"articles": articles, "flag": flag}, function(ret){
      hide_wait_process();
      if(ret.code == 0){
        show_success_modal("设置成功！");
      }else if(ret.code == 1){
        show_success_modal("设置失败！");
      }else{
        return
      }
      show_rss_articles_modal(id);
    });
  }

  // 报文下载
  function articles_download(id, articles){
    $("#modal-rss-articles").modal('hide');
    show_wait_process();
    ajax_post("rss_articles_download", {"articles": articles, "taskid": id}, function(ret){
      hide_wait_process();
      if(ret.code == 0){
        show_success_modal("添加下载成功！");
      }else if(ret.code == 1){
        show_fail_modal(" 添加下载失败！");
      }else{
        return
      }
      show_rss_articles_modal(id);
    });
  }

  // 单个报文下载
  function single_article_download(id, article_id){
    article = [{title: $(`#title_${article_id}`).val(), enclosure: $(`#enclosure_${article_id}`).val()}];
    articles_download(id, article);
  }

  // rss报文测试
  function rss_article_test(id, taskid, title){
    var info_id = `#info_${id}`;
    var flag_id = `#flag_${id}`;
    make_cursor_busy();
    ajax_post("rss_article_test", {"taskid": taskid, "title": title}, function (ret) {
      cancel_cursor_busy();
      if(ret.code == 0){
        $(info_id).empty();
        var ignored_words = [];
        var replaced_words = [];
        var offset_words = [];
        if(ret.data.ignored_words){
          ignored_words = ret.data.ignored_words;
        }
        if(ret.data.replaced_words){
          replaced_words = ret.data.replaced_words;
        }
        if(ret.data.offset_words){
          offset_words = ret.data.offset_words;
        }
        var words = ignored_words + replaced_words + offset_words;
        if(words.length != 0){
          if(ret.data.org_string){
            $(info_id).append(`<div class="mb-3" ><label class="form-label">识别使用名称：<span class="badge badge-outline text-cyan me-1 mb-1" style="vertical-align: middle;white-space: normal;text-align: left;word-break: break-all;" title="自定义识别词过滤后识别用名">${ret.data.org_string}</span></label></div>`);
          }
          if(ignored_words.length != 0){
            var ignored_word_content = '<div class="mb-3"><label class="form-label">应用屏蔽词：';
            for(ignored_word of ignored_words){
              ignored_word_content = ignored_word_content + `<span class="badge badge-outline text-cyan me-1 mb-1" style="vertical-align: middle;">${ignored_word}</span>`;
            };  
            $(info_id).append(ignored_word_content + '</label></div>');
          }
          if(replaced_words.length != 0){
            var replaced_words_content = '<div class="mb-3"><label class="form-label">应用替换词：';
            for(replaced_word of replaced_words){
              replaced_words_content = replaced_words_content + `<span class="badge badge-outline text-cyan me-1 mb-1" style="vertical-align: middle;">${replaced_word}</span>`;
            };
            $(info_id).append(replaced_words_content + '</label></div>');
          }
          if(offset_words.length != 0){
            var offset_words_content = '<div class="mb-3"><label class="form-label">应用集数偏移：';
            for(offset_word of offset_words){
              offset_words_content = offset_words_content + `<span class="badge badge-outline text-cyan me-1 mb-1" style="vertical-align: middle;">${offset_word}</span>`;
            };
            $(info_id).append(offset_words_content + '</label></div>');
          }
        }
        if(ret.data.type){
          $(info_id).append(`<span class="badge badge-outline text-blue me-1 mb-1" title="类型">${ret.data.type}</span>`);
        }
        if(ret.data.category){
          $(info_id).append(`<span class="badge badge-outline text-blue me-1 mb-1" title="类别">${ret.data.category}</span>`);
        }
        if(ret.data.name){
          $(info_id).append(`<span class="badge badge-outline text-red me-1 mb-1" title="识别名称">${ret.data.name}</span>`);
        }
        if(ret.data.title){
          $(info_id).append(`<span class="badge badge-outline text-red me-1 mb-1" title="标题">${ret.data.title}</span>`);
        }
        if(ret.data.year){
          $(info_id).append(`<span class="badge badge-outline text-orange me-1 mb-1" title="年份">${ret.data.year}</span>`);
        }
        if(ret.data.season_episode){
          $(info_id).append(`<span title="季集"><a class="badge badge-outline text-orange me-1 mb-1" href="${ret.data.tmdb_S_E_link}" target="_blank">${ret.data.season_episode}</a></span>`);
        }
        if(ret.data.part){
          $(info_id).append(`<span class="badge badge-outline text-orange me-1 mb-1" title="分集">${ret.data.part}</span>`);
        }
        if(ret.data.tmdbid){
          $(info_id).append(`<span title="TMDB ID"><a class="badge badge-outline text-green me-1 mb-1" href="${ret.data.tmdblink}" target="_blank">${ret.data.tmdbid}</a></span>`);
        }
        if(ret.data.restype){
          $(info_id).append(`<span class="badge me-1 mb-1" title="质量">${ret.data.restype}</span>`);
        }
        if(ret.data.pix){
          $(info_id).append(`<span class="badge me-1 mb-1" title="分辨率">${ret.data.pix}</span>`);
        }
        if(ret.data.video_codec){
          $(info_id).append(`<span class="badge me-1 mb-1" title="视频编码">${ret.data.video_codec}</span>`);
        }
        if(ret.data.audio_codec){
          $(info_id).append(`<span class="badge me-1 mb-1" title="音频编码">${ret.data.audio_codec}</span>`);
        }
        if(ret.data.team){
          $(info_id).append(`<span class="badge badge-outline text-yellow me-1 mb-1" title="制作组/字幕组">${ret.data.team}</span>`);
        }
        if(ret.data.match_flag){
          $(flag_id).append(`<br><span class="badge badge-outline text-green me-1 mb-1">匹配</span>`);
        }else{
          $(flag_id).append(`<br><span class="badge badge-outline text-red me-1 mb-1">不匹配</span>`);
        }
        if(ret.data.exist_flag){
          $(flag_id).append(`<br><span class="badge badge-outline text-green me-1 mb-1">本地已存在</span>`);
        }else{
          $(flag_id).append(`<br><span class="badge badge-outline text-orange me-1 mb-1">本地不存在</span>`);
        }
      }
    })
  }

  // 订阅下载记录
  function show_rss_history_modal(id){
    show_wait_process();
    ajax_post("list_rss_history", {"id": id}, function(ret){
      hide_wait_process();
      if(ret.code == 0){
        downloads = ret.data;
        var content_th = `<thead><tr>
                          <th>标题</th>
                          <th>下载器</th>
                          <th>下载时间</th>
                          </tr></thead>`;
        var content_td = '';
        for(var i = 0; i < downloads.length; i ++){
          var download = downloads[i];
          var title = '';
          var downloader = '';
          var date = '';
          if(download.title){
            title = `<span>${download.title}</span>`
          };
          if(download.date){
            date = download.date.split(" ");
            date = `<small>${date[0]}<br>${date[1]}</small>`;
          };
          if(download.downloader){
            downloader = `<span class="badge me-1 mb-1" title="下载器">${download.downloader}</span>`;
          };
          var content_td = `${content_td}<tr><td>${title}</td>><td>${downloader}</td><td class="text-nowrap">${date}</td></tr>`;
        content_tb = `<tbody>${content_td}</tbody>`;
        content = `${content_th}${content_tb}`;
        };
      }else{
        var content = `<div class="empty"><p class="empty-title">${ret.msg}</p></div>`;
      };
      $("#table-rss-history").empty();
      $("#table-rss-history").append(content);
      $("#modal-rss-history").modal('show');
    });
  }

  // 应用订阅模板
  function apply_templated(loop_index){
    var task = {{ Tasks | safe}}[loop_index];
    $("#userrss_interval").val(task.interval);
    $("#userrss_include").val(task.include);
    $("#userrss_exclude").val(task.exclude);
    $("#userrss_filterrule").val(task.filter);
    $("#userrss_parser").val(task.parser);
    $("#userrss_state").val(task.state);
    $("#userrss_uses").val(task.uses);
    $("#userrss_note_path").val(task.note.save_path);
    $("#userrss_note_category").val(task.note.category);
    $("#userrss_note_tags").val(task.note.tags);
    $("#userrss_note_layout").val(task.note.content_layout);
    $("#userrss_note_paused").val(task.note.is_paused);
    $("#userrss_note_upload").val(task.note.upload_limit);
    $("#userrss_note_download").val(task.note.download_limit);
    $("#userrss_note_ratio").val(task.note.ratio_limit);
    $("#userrss_note_seeding_time").val(task.note.seeding_time_limit);
  }

</script>